# Инструмент qdrant_search_memory

Инструмент для семантического поиска по истории сообщений в Qdrant.

## Описание

`qdrant_search_memory` позволяет агенту искать релевантные сообщения в долгосрочной памяти с использованием векторного поиска.

## Параметры

### Обязательные

- **query_text** (string) - Текстовый запрос для поиска. Опишите, что вы ищете, естественным языком.

### Опциональные

- **limit** (integer) - Максимальное количество результатов (по умолчанию: 5, максимум: 20)

- **filters** (object) - Фильтры для уточнения поиска:
  - **role** (string) - Фильтр по роли: `user`, `assistant`, или `system`
  - **session_key** (string) - Фильтр по ключу сессии (например, `telegram:123456`)
  - **timestamp_from** (string) - Фильтр сообщений от этой даты (формат ISO 8601: `2024-01-01T00:00:00Z`)
  - **timestamp_to** (string) - Фильтр сообщений до этой даты (формат ISO 8601)

## Примеры использования

### Базовый поиск

```json
{
  "query_text": "Как настроить Docker?"
}
```

### Поиск с ограничением результатов

```json
{
  "query_text": "инструкция по установке",
  "limit": 10
}
```

### Поиск с фильтром по роли

```json
{
  "query_text": "команды для развёртывания",
  "filters": {
    "role": "user"
  }
}
```

### Поиск с фильтром по сессии

```json
{
  "query_text": "последние настройки",
  "filters": {
    "session_key": "telegram:123456"
  }
}
```

### Поиск с временным диапазоном

```json
{
  "query_text": "конфигурация сервера",
  "filters": {
    "timestamp_from": "2024-01-01T00:00:00Z",
    "timestamp_to": "2024-12-31T23:59:59Z"
  }
}
```

### Комбинированный поиск

```json
{
  "query_text": "ошибки подключения к базе данных",
  "limit": 15,
  "filters": {
    "role": "assistant",
    "timestamp_from": "2024-06-01T00:00:00Z"
  }
}
```

## Формат ответа

Инструмент возвращает отформатированный текст с найденными сообщениями:

```
Found 3 relevant message(s):

### Message 1
**Role:** user
**Time:** 2024-01-15T10:30:00Z
**Content:** Как установить Docker на Ubuntu?
**Session:** telegram:123456

---

### Message 2
**Role:** assistant
**Time:** 2024-01-15T10:30:15Z
**Content:** Для установки Docker на Ubuntu выполните следующие команды...
**Session:** telegram:123456

---

### Message 3
**Role:** user
**Time:** 2024-01-15T10:31:00Z
**Content:** Спасибо, помогло!
**Session:** telegram:123456
```

## Конфигурация

Для работы инструмента необходимо включить Qdrant в конфигурации:

```json
{
  "storage": {
    "qdrant": {
      "enabled": true,
      "host": "localhost",
      "port": 6333,
      "collection": "picoclaw_messages",
      "vector_size": 1024
    }
  },
  "model_list": [{
    "model_name": "mistral-embed",
    "model": "mistral/mistral-embed",
    "api_base": "https://api.mistral.ai/v1",
    "api_key": "ваш-api-ключ"
  }]
}
```

## Ошибки

### Qdrant не настроен
```
Qdrant memory search is not configured. Enable it in config to search long-term memory.
```

### Отсутствует query_text
```
Error: query_text is required and must be a non-empty string
```

### Ошибка поиска
```
Error searching memory: <описание ошибки>
```

### Ничего не найдено
```
No relevant messages found in memory.
```

## Рекомендации по использованию

1. **Используйте естественный язык** - запрос должен описывать то, что вы ищете, а не содержать ключевые слова

2. **Фильтруйте по роли** - если ищете только вопросы пользователя или только ответы ассистента

3. **Ограничивайте результаты** - используйте `limit` для получения только самых релевантных сообщений

4. **Используйте временные фильтры** - для поиска в определённый период времени

5. **Комбинируйте фильтры** - для более точного поиска используйте несколько фильтров одновременно

## Технические детали

- **Векторизация**: Используется модель `mistral-embed` (1024 измерения)
- **Поиск**: Косинусное сходство векторов
- **Фильтрация**: Пост-обработка результатов на стороне клиента
- **Производительность**: Типичное время поиска <100мс

## Лицензия

MIT License
